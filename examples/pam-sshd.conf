# PAM configuration for SSH with Web3 authentication
# Copy to /etc/pam.d/sshd or merge with existing config
#
# This configuration enables Web3 wallet authentication ONLY for
# specific users (e.g., web3test). All other users use standard
# authentication (passwords, SSH keys, etc.)

# Web3 wallet authentication (only for specified user)
# - If user is NOT "web3test", skip the next line and use standard auth
# - If user IS "web3test", require web3 auth (success=login, fail=deny)
auth [success=1 default=ignore] pam_succeed_if.so user != web3test
auth [success=done default=die] pam_web3.so

# Standard Un*x authentication (for all other users)
@include common-auth

# --- Everything below is standard sshd PAM config ---

# Disallow non-root logins when /etc/nologin exists.
account    required     pam_nologin.so

# Standard Un*x authorization.
@include common-account

# SELinux needs to be the first session rule.
session [success=ok ignore=ignore module_unknown=ignore default=bad]        pam_selinux.so close

# Set the loginuid process attribute.
session    required     pam_loginuid.so

# Create a new session keyring.
session    optional     pam_keyinit.so force revoke

# Standard Un*x session setup and teardown.
@include common-session

# Print the message of the day upon successful login.
session    optional     pam_motd.so  motd=/run/motd.dynamic
session    optional     pam_motd.so noupdate

# Print the status of the user's mailbox upon successful login.
session    optional     pam_mail.so standard noenv

# Set up user limits from /etc/security/limits.conf.
session    required     pam_limits.so

# Read environment variables from /etc/environment and /etc/security/pam_env.conf.
session    required     pam_env.so
session    required     pam_env.so user_readenv=1 envfile=/etc/default/locale

# SELinux needs to intervene at login time.
session [success=ok ignore=ignore module_unknown=ignore default=bad]        pam_selinux.so open

# Standard Un*x password updating.
@include common-password


# =============================================================================
# ALTERNATIVE CONFIGURATIONS
# =============================================================================

# --- Option A: Web3 auth for a LIST of users ---
# auth [success=1 default=ignore] pam_succeed_if.so user notin web3user1:web3user2:web3user3
# auth [success=done default=die] pam_web3.so
# @include common-auth

# --- Option B: Web3 auth for a GROUP of users ---
# auth [success=1 default=ignore] pam_succeed_if.so user notingroup web3users
# auth [success=done default=die] pam_web3.so
# @include common-auth

# --- Option C: Web3 auth for ALL users (no fallback) ---
# auth [success=done default=die] pam_web3.so

# --- Option D: Web3 auth for ALL users (with password fallback) ---
# auth sufficient pam_web3.so
# @include common-auth
